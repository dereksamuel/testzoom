<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    svg {
      border: 1px solid #333;
      box-sizing: border-box;
    }
    #info {
      box-sizing: border-box;
      border: 1px solid #DEDEDE;
      padding: 10px;
      width: 600px;
    }

    #info p {
      margin: 0;
      padding: 1px;
    }
  </style>
  <script src="https://hammerjs.github.io/dist/hammer.min.js"></script>
</head>
<body>
  <svg id="svg" width="1085" height="845" viewBox="0 0 1085 845" fill="none" xmlns="http://www.w3.org/2000/svg">
    <rect width="1085" height="845" fill="#F5F5F5"/>
    <g id="Base">
        <path d="M717 165L741.5 130M741.5 130L762 112L741.5 98V89L722.75 117.25M741.5 130L722.75 117.25M704 104.5L722.75 117.25" stroke="black"/>
        <path d="M674 4L744.98 46.0874L778.236 71.8349M778.236 71.8349L830.851 104.515L820.427 114.913L778.236 83.2233V71.8349ZM704.278 4L914.736 139.175L947 157" stroke="black"/>
        <path d="M596 1.5L370 307.5H358.5L213 503V512M581 512V616H496L399.5 742L358.5 716H272.5V599H281.5V590H252V536H213V512M581 512H437V522M581 512V492.5H548.5H530.5M437 522H425.5V503H530.5V492.5M437 522V653L393 693V512H213M530.5 492.5V436L542 400" stroke="black"/>
        <path d="M35 710L117 602L122 608L184 524L174 518L563 2M563 2H596H642H1080V843H1V2H563Z" stroke="black"/>
        <rect x="540" y="163" width="42" height="134" fill="#D9D9D9"/>
        <path d="M2.5 819L37 839.5L69.5 788L37 758.5H24.5V738L37 712.5L69.5 662L115.5 603H122M534.5 167.5H582V298.5H534.5V167.5Z" stroke="black"/>
        <path d="M472 648H653.455V382H749.403V352.5H726.038V303.5H736.478V246V229H726.038V215H736.478V202H912.962H999.464V215M999.464 215H921.91V288H954.721V275.5H1080V215H999.464Z" stroke="black"/>
        <path d="M850.5 170H605V273H627V302.5H605V346H673.5L667 273H685V258.5M850.5 170H916V176.5H850.5V170ZM685 258.5H654M685 258.5V204.5H999.5V213.5L921.5 217.5V289.5H956V273H1079.5" stroke="black"/>
        <path d="M643.5 67L611.5 48L629.5 23.5L715.5 78.5L703 103L656.5 78.5" stroke="black"/>
        <path d="M512.5 323H475.5V371.5H512.5V323Z" stroke="black"/>
        <path d="M419 437.5V312.5H533V324H575.5V386H637.5V437.5H419Z" stroke="black"/>
        <path d="M533 324V399H542.5" stroke="black"/>
        <!-- <path d="M652.958 127.343C650.273 132.848 644.367 136.213 636.872 137.125C629.382 138.037 620.374 136.484 611.637 132.223C602.9 127.961 596.13 121.818 592.237 115.355C588.341 108.887 587.357 102.162 590.042 96.657C592.727 91.1516 598.633 87.7869 606.128 86.8747C613.618 85.9633 622.626 87.5158 631.363 91.7771C640.1 96.0385 646.87 102.182 650.763 108.645C654.659 115.113 655.643 121.838 652.958 127.343Z" fill="#D9D9D9"/>
        <path d="M652.958 127.343C650.273 132.848 644.367 136.213 636.872 137.125C629.382 138.037 620.374 136.484 611.637 132.223C602.9 127.961 596.13 121.818 592.237 115.355C588.341 108.887 587.357 102.162 590.042 96.657C592.727 91.1516 598.633 87.7869 606.128 86.8747C613.618 85.9633 622.626 87.5158 631.363 91.7771C640.1 96.0385 646.87 102.182 650.763 108.645C654.659 115.113 655.643 121.838 652.958 127.343Z" stroke="black"/> -->
        <path d="M278.5 518V484.5L315.5 439H375.5V352.5L407 313.5" stroke="black"/>
        <path d="M707 844.5L1072.5 467V544.5L779.5 844.5H839.5L1072.5 587M680.5 844.5V797H659.5V844.5H680.5Z" stroke="black"/>
        <path d="M420 313.5H406.5" stroke="black"/>
        <path d="M1084 138.5L886 6H918.5L1084 115.5V138.5Z" stroke="black"/>
        <path d="M921.5 103.5L752 1" stroke="black"/>
        <path d="M991.5 150L1079 191" stroke="black"/>
        
    </g>
    <g id="Rooms">
      <a id="ovalo" xlink:href="#" >
        <g>
          <path fill="#E6E6E6" d="M652.958 127.343C650.273 132.848 644.367 136.213 636.872 137.125C629.382 138.037 620.374 136.484 611.637 132.223C602.9 127.961 596.13 121.818 592.237 115.355C588.341 108.887 587.357 102.162 590.042 96.657C592.727 91.1516 598.633 87.7869 606.128 86.8747C613.618 85.9633 622.626 87.5158 631.363 91.7771C640.1 96.0385 646.87 102.182 650.763 108.645C654.659 115.113 655.643 121.838 652.958 127.343Z"/>
          <path d="M652.958 127.343C650.273 132.848 644.367 136.213 636.872 137.125C629.382 138.037 620.374 136.484 611.637 132.223C602.9 127.961 596.13 121.818 592.237 115.355C588.341 108.887 587.357 102.162 590.042 96.657C592.727 91.1516 598.633 87.7869 606.128 86.8747C613.618 85.9633 622.626 87.5158 631.363 91.7771C640.1 96.0385 646.87 102.182 650.763 108.645C654.659 115.113 655.643 121.838 652.958 127.343Z" stroke="black"/>
        </g>
      </a>
      <a id="lobby_1_" xlink:href="#" >
        <g>
          <path d="M580.5 648.5H472L496 616.5H580.5" stroke="#6217C1"/>
        </g>
            
      </a>
    </g>
    <g id="Portals">
      <!-- <line id="Elev.1.floor1" fill="none" stroke="#FF00FF" x1="297" y1="237" x2="315" y2="255"/>
      <line id="Stair.1.floor1" fill="none" stroke="#FF00FF" x1="315" y1="273" x2="306" y2="273"/> -->
    </g>
    <g id="Doors">
      <!-- <line id="R201_1_" fill="none" stroke="#00FF00" x1="297" y1="408" x2="306" y2="417"/>
      <line id="R202_1_" fill="none" stroke="#00FF00" x1="504" y1="111" x2="513" y2="102"/>
      <line id="R203_1_" fill="none" stroke="#00FF00" x1="117" y1="345" x2="126" y2="354"/> -->
        <line id="ovalo_1_" fill="none" stroke="#00FF00" x1="610" y1="130" x2="610" y2="160"/>
        <line id="lobby" fill="none" stroke="#00FF00" x1="610" y1="610" x2="580" y2="630"/>
    </g>
    <g id="Paths">
        <line fill="none" stroke="#00FFFF" x1="645" y1="630" x2="580" y2="630"/>
        <line fill="none" stroke="#00FFFF" x1="645" y1="630" x2="645" y2="365"/>
        <line fill="none" stroke="#00FFFF" x1="645" y1="365" x2="595" y2="365"/>
        <line fill="none" stroke="#00FFFF" x1="595" y1="150" x2="595" y2="365"/>
        <line fill="none" stroke="#00FFFF" x1="595" y1="150" x2="610" y2="130"/>
    </g>
    </svg>
  <script>
    window.addEventListener("load", init);
    const svgElement = document.getElementById("svg");
    //  Create Manager
    const mc = new Hammer.Manager(svgElement);
    function init() {
      // Create Recognizer
      const pinch = new Hammer.Pinch();
      const pan = new Hammer.Pan();

      pinch.requireFailure(pan);

      //  把 recognizer 加到 manager
      mc.add([pinch, pan]);

      mc.on("pinchstart", () => {
        console.log("pinchstart");
      });
      mc.on("pinchmove", zoom);
      mc.on("pinchend", pinchend);
      mc.on("panstart", panstart);
      mc.on("panmove", panmove);
      mc.on("panend", panend);

      //  回報滑鼠座標事件
      // svgElement.addEventListener('mousemove', reportCurrentPoint, false)
      //  拖曳的事件
      // svgElement.addEventListener('mousedown', mouseDown, false)
      // svgElement.addEventListener('mousemove', drag, false)
      // svgElement.addEventListener('mouseup', mouseUp, false)
      //  縮放的事件
      svgElement.addEventListener("wheel", zoom, false);
    }

    /*
    開始：滑鼠拖拉的效果
    */
    let paning;
    let startViewBox = null;

    function panstart() {
      paning = true;
      console.log("panstart");
      //  1. 取得一開始的 viewBox 值，原本是字串，拆成陣列，方便之後運算
      startViewBox = svgElement
        .getAttribute("viewBox")
        .split(" ")
        .map(n => parseFloat(n));
    }
    //  拖拉的移動過程
    function panmove(e) {
      if (paning) {
        //  2. 取得 pointer 當前 viewport 中 client 座標值
        let startClient = {
          x: e.changedPointers[0].clientX,
          y: e.changedPointers[0].clientY
        };

        //  3. 計算對應回去的 SVG 座標值
        let newSVGPoint = svgElement.createSVGPoint();
        let CTM = svgElement.getScreenCTM();
        newSVGPoint.x = startClient.x;
        newSVGPoint.y = startClient.y;
        let startSVGPoint = newSVGPoint.matrixTransform(CTM.inverse());

        //  4. 計算拖曳後滑鼠所在的 viewport client 座標值
        let moveToClient = {
          x: e.changedPointers[0].clientX + e.deltaX,
          y: e.changedPointers[0].clientY + e.deltaY
        };

        //  5. 計算對應回去的 SVG 座標值
        newSVGPoint = svgElement.createSVGPoint();
        CTM = svgElement.getScreenCTM();
        newSVGPoint.x = moveToClient.x;
        newSVGPoint.y = moveToClient.y;
        let moveToSVGPoint = newSVGPoint.matrixTransform(CTM.inverse());

        // 6. 計算位移量
        let delta = {
          dx: startSVGPoint.x - moveToSVGPoint.x,
          dy: startSVGPoint.y - moveToSVGPoint.y
        };
        //  7. 設定新的 viewBox 值
        let moveToViewBox = `${startViewBox[0] + delta.dx} ${startViewBox[1] + delta.dy} ${startViewBox[2]} ${startViewBox[3]}`;
        svgElement.setAttribute("viewBox", moveToViewBox);
      }
    }

    //  滑鼠點擊結束（拖曳結束）
    function panend() {
      console.log("panend");
      paning = false;
    }
    //  結束：滑鼠拖拉的效果

    /*
    開始：滑鼠縮放的效果
    */
    let adjustScale = 1;
    let currentScale = null;
    let ratio = 1;

    function zoom(e) {
      //  1.取得一開始的 viewBox。
      let startViewBox = svgElement
        .getAttribute("viewBox")
        .split(" ")
        .map(n => parseFloat(n));

      //  2.取得滑鼠執行縮放位置的 viewPort Client 座標，並利用 CTM 對應取得 SVG 座標。

      //  2.1 取得滑鼠執行縮放的位置
      let startClient;
      if (e.type === "wheel") {
        startClient = {
          x: e.clientX,
          y: e.clientY
        };
      }
      if (e.type === "pinchmove") {
        startClient = {
          x: e.center.x,
          y: e.center.y
        };
      }

      //  2.2 轉換成 SVG 座標系統中的 SVG 座標點
      let newSVGPoint = svgElement.createSVGPoint();
      let CTM = svgElement.getScreenCTM();
      newSVGPoint.x = startClient.x;
      newSVGPoint.y = startClient.y;
      let startSVGPoint = newSVGPoint.matrixTransform(CTM.inverse());

      //  3.進行縮放，如果要讓原本的尺寸縮放兩倍的話。
      //  3.1 設定縮放倍率
      let zoomSize = {
        max: 2,
        min: 0.5
      };

      let viewport = {
        width: svgElement.getBoundingClientRect().width,
        height: svgElement.getBoundingClientRect().height
      };

      if (e.type === "wheel") {
        let tmp = ratio + e.deltaY / 100;
        console.log('tmp', tmp)
        if (tmp >= zoomSize.max) {
          tmp = zoomSize.max;
        }
        if (tmp <= zoomSize.min) {
          tmp = zoomSize.min;
        }
        ratio = tmp;
      }

      if (e.type === "pinchmove") {
        currentScale = adjustScale * e.scale;
        ratio = 1 / currentScale;

        if (ratio >= zoomSize.max) {
          ratio = zoomSize.max;
          currentScale = 1 / zoomSize.max;
        }

        if (ratio <= zoomSize.min) {
          ratio = zoomSize.min;
          currentScale = 1 / zoomSize.min;
        }
      }

      //  3.2 進行縮放

      svgElement.setAttribute(
        "viewBox",
        `${startViewBox[0]} ${startViewBox[1]} ${viewport.width * ratio} ${viewport.height * ratio}`
      );

      //  4.將一開始滑鼠的執行縮放位置的 viewPort Client 座標利用新的 CTM ，轉換出對應的 SVG 座標。
      CTM = svgElement.getScreenCTM();
      let moveToSVGPoint = newSVGPoint.matrixTransform(CTM.inverse());

      //  5.取得在縮放過程中該圓點的位移量 `(svgElementX0 - svgElementX1)`。
      let delta = {
        dx: startSVGPoint.x - moveToSVGPoint.x,
        dy: startSVGPoint.y - moveToSVGPoint.y
      };

      //  6.設定最終的 viewBox2
      let middleViewBox = svgElement
        .getAttribute("viewBox")
        .split(" ")
        .map(n => parseFloat(n));
      let moveBackViewBox = `${middleViewBox[0] + delta.dx} ${middleViewBox[1] + delta.dy} ${middleViewBox[2]} ${middleViewBox[3]}`;
      svgElement.setAttribute("viewBox", moveBackViewBox);
    }

    function pinchend(e) {
      adjustScale = currentScale;
      mc.off("pan");
      setTimeout(mc.on("pan"), 100);
      console.log("pinchend");
    }
  </script>
</body>
</html>